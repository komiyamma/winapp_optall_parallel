# optall_parallel に関する問題点

このツールは「optipng を単純に並列で呼び出す」という目的に沿ったシンプルな実装ですが、より多くのユーザーにとって使いやすく、安全なツールにするための改善点がいくつか見受けられます。

## 1. 設定の柔軟性に関する課題

現在の実装では、多くの設定値がソースコード内に直接記述（ハードコード）されています。これにより、ユーザーが環境に合わせて動作を調整する際に、ソースコードの編集と再コンパイルが必要になってしまいます。

- **課題1-1: 並列実行数が固定されている**
  - **現状:** 並列実行数が `7` に固定されています。
  - **問題点:** CPUのコア数が少ない、あるいは非常に多い環境では、この固定値が最適であるとは限りません。リソースを最大限に活用できなかったり、逆にシステムに負荷をかけすぎたりする可能性があります。
  - **改善案:**
    - コマンドライン引数で並列数を指定できるようにする。（例: `-p 4`）
    - 引数が指定されない場合は、`Environment.ProcessorCount`（システムの論理プロセッサ数）をデフォルト値として使用する。

- **課題1-2: OptiPNGの実行オプションが固定されている**
  - **現状:** 実行オプションが `-strip all -o 7` に固定されています。
  - **問題点:** より圧縮率の低い高速な最適化を試したい場合や、画像のメタデータ（著作権情報など）を保持したい場合に、ユーザーは設定を変更できません。
  - **改善案:** コマンドライン引数でOptiPNGのオプションを自由に設定できるようにする。

## 2. 堅牢性・エラーハンドリングに関する課題

予期せぬ状況やエラーに対する配慮が不足しており、ユーザーが問題の原因を特定しにくい場合があります。

- **課題2-1: 外部ツール(OptiPNG)の存在チェックがない**
  - **現状:** プログラム実行時に `optipng.exe` がシステムのPATH上に存在するかどうかを確認していません。
  - **問題点:** `optipng.exe` がインストールされていない、またはPATHが通っていない環境で実行すると、処理対象のファイルすべてでエラーが発生し、ユーザーを混乱させます。
  - **改善案:** プログラム開始時に一度だけ `optipng.exe` の存在をチェックし、見つからない場合はエラーメッセージを表示して処理を中断する。

- **課題2-2: 最適化失敗時のフィードバックが不十分**
  - **現状:** OptiPNGが0以外の終了コードを返した場合（最適化失敗など）でも、その旨をコンソールに出力するだけで、処理は続行されます。
  - **問題点:** 多くのファイルの中にエラーが埋もれてしまい、どのファイルで問題が発生したのかが分かりにくいです。
  - **改善案:** 処理終了後に、エラーが発生したファイルの一覧と、その際の終了コードをまとめて報告する。

- **課題2-3: 処理対象ファイルが存在しない場合の挙動**
  - **現状:** カレントディレクトリに `.png` ファイルが一つも無い場合でも、「全ての PNG 最適化が完了しました。」というメッセージが表示されます。
  - **問題点:** ユーザーは「何も起こらなかったが、正常に終わった」と誤解する可能性があります。
  - **改善案:** 対象ファイルが見つからなかった旨を伝えるメッセージ（例: 「処理対象のPNGファイルが見つかりませんでした。」）を表示する。

## 3. 利便性に関する課題

ツールの使い勝手を向上させるための、いくつかの基本的な機能が不足しています。

- **課題3-1: 処理対象ディレクトリを指定できない**
  - **現状:** 実行したカレントディレクトリ内のファイルしか処理できません。
  - **問題点:** 別の場所にあるPNGファイルを最適化したい場合、わざわざそのディレクトリに移動するか、本ツールをコピーする必要があります。
  - **改善案:** コマンドライン引数で処理対象のディレクトリパスを指定できるようにする。

- **課題3-2: 元のファイルを上書きしてしまう**
  - **現状:** 最適化が完了した画像は、元のファイルを上書き保存します。
  - **問題点:** 操作ミスや、OptiPNGのバージョンによる予期せぬ結果によって、元の画像を失うリスクがあります。重要な画像を扱う際には非常に危険です。
  - **改善案:**
    - `-b` や `--backup` のような引数で、上書き前に `.bak` などの拡張子を付けてバックアップを作成する機能を追加する。
    - `-d <path>` のような引数で、最適化後のファイルの出力先ディレクトリを指定できるようにする。

- **課題3-3: サブディレクトリ内のファイルを処理できない**
  - **現状:** サブディレクトリ内のPNGファイルは処理の対象外です。
  - **問題点:** フォルダ内に多数のサブディレクトリが存在する場合、それぞれでコマンドを実行する必要があり、手間がかかります。
  - **改善案:** `-r` や `--recursive` のような引数で、サブディレクトリ内も再帰的に探索して処理対象に含める機能を追加する。
